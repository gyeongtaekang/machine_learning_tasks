import argparse
import os
import copy

import torch
from torch import nn
import torch.optim as optim
import torch.backends.cudnn as cudnn
from torch.utils.data.dataloader import DataLoader
from tqdm import tqdm

from models import SRCNN
from datasets import TrainDataset, TestDataset
from utils import AverageMeter, calc_psnr



if __name__ == '__main__':


    parser = argparse.ArgumentParser()
    # 학습 데이터 경로
    parser.add_argument('--train-dir', type=str, default='./db/train')
    # 테스트 데이터 경로
    parser.add_argument('--test-dir', type=str, default='./db/test')
    # 모델 파일 저장 경로
    parser.add_argument('--outputs-dir', type=str, default='./outputs')
    # 학습률
    parser.add_argument('--lr', type=float, default=1e-4)
    # 미니 배치 크기
    parser.add_argument('--batch-size', type=int, default=16)
    # 에포크 수 설정
    parser.add_argument('--num-epochs', type=int, default=400)
    # 아래의 3개 argument는 변경 불필요
    # 4배로 업스케일
    parser.add_argument('--scale', type=int, default=4)
    parser.add_argument('--num-workers', type=int, default=8)
    parser.add_argument('--seed', type=int, default=123)
    # 체크포인트 경로 추가
    parser.add_argument('--resume', type=str, default=None, help='Path to checkpoint to resume training')
    args = parser.parse_args()


    if not os.path.exists(args.outputs_dir):
        os.makedirs(args.outputs_dir)

    cudnn.benchmark = True
    if not torch.cuda.is_available():
        raise RuntimeError("CUDA가 사용 불가능합니다. CUDA 설치를 확인해주세요.")
    device = torch.device('cuda:0')
    torch.manual_seed(args.seed)

    # 모델 초기화
    model = SRCNN().to(device)

    # 손실 함수 정의
    criterion = nn.MSELoss()  # 또는 다른 손실 함수 사용

    # 옵티마이저 초기화 (예: Adam 사용)
    optimizer = optim.Adam(model.parameters(), lr=args.lr)

    # 체크포인트 로딩
    start_epoch = 1
    if args.resume:
        if os.path.isfile(args.resume):
            print(f"체크포인트 '{args.resume}' 로드 중...")
            checkpoint = torch.load(args.resume)
            print(f"체크포인트 키: {checkpoint.keys()}")
            
            if 'model_state_dict' in checkpoint:
                model.load_state_dict(checkpoint['model_state_dict'])
                optimizer.load_state_dict(checkpoint['optimizer_state_dict'])
                start_epoch = checkpoint['epoch'] + 1
                print(f"에포크 {start_epoch}부터 학습을 재개합니다.")
            else:
                # 'model_state_dict' 키가 없는 경우 전체 state_dict를 로드
                model.load_state_dict(checkpoint)
                print("체크포인트에 'model_state_dict' 키가 없어 전체 모델을 로드했습니다.")
        else:
            raise FileNotFoundError(f"체크포인트 파일을 찾을 수 없습니다: {args.resume}")

    train_dataset = TrainDataset(args.train_dir, is_train=1, scale=args.scale)
    train_dataloader = DataLoader(dataset=train_dataset,
                                  batch_size=args.batch_size,
                                  shuffle=True,
                                  num_workers=0,
                                  pin_memory=True,
                                  drop_last=True)
    #eval_dataset = TrainDataset(args.test_dir, is_train=0, scale=args.scale)
    eval_dataset = TestDataset(args.test_dir, scale=args.scale)
    eval_dataloader = DataLoader(dataset=eval_dataset, batch_size=1, shuffle=False)


    best_weights = copy.deepcopy(model.state_dict())
    best_epoch = 0
    best_psnr = 0.0

    for epoch in range(start_epoch, args.num_epochs + 1):

        model.train()
        epoch_losses = AverageMeter()

        with tqdm(total=(len(train_dataset) - len(train_dataset) % args.batch_size)) as t:
            t.set_description(f'epoch: {epoch}/{args.num_epochs}')
            
            for data in train_dataloader:
                inputs, labels = data
                inputs = inputs.to(device)
                labels = labels.to(device)

                # 예측값
                preds = model(inputs)

                # 손실 계산
                loss = criterion(preds, labels)
                epoch_losses.update(loss.item(), len(inputs))

                # 로그 출력
                print(f"Epoch: {epoch}, Loss: {loss.item()}")

                # 그레디언트 초기화, 역전파, 옵티마이저 스텝
                optimizer.zero_grad()
                loss.backward()
                optimizer.step()

                t.set_postfix(loss=f'{epoch_losses.avg:.6f}')
                t.update(len(inputs))
        torch.save(model.state_dict(), "{}/epoch_{}.pth".format(args.outputs_dir, epoch))

        model.eval()
        epoch_psnr = AverageMeter()

        if (epoch + 1) % 5 == 0:
            epoch_psnr = torch.zeros(len(eval_dataloader))
            n = -1
            for data in eval_dataloader:
                n += 1
                inputs, labels = data

                inputs = inputs.to(device)
                labels = labels.to(device)

                with torch.no_grad():
                    preds = model(inputs).clamp(0.0, 1.0)
                epoch_psnr[n] = calc_psnr(preds, labels)

            epoch_psnr_avg = torch.mean(epoch_psnr)
            print('eval psnr: {:.2f}'.format(epoch_psnr_avg ))

            if epoch_psnr_avg > best_psnr:
                best_epoch = epoch
                best_psnr = epoch_psnr_avg
                best_weights = copy.deepcopy(model.state_dict())

        # 에포크 종료 후 체크포인트 저장
        checkpoint_path = os.path.join(args.outputs_dir, f'epoch_{epoch}.pth')
        torch.save({
            'epoch': epoch,
            'model_state_dict': model.state_dict(),
            'optimizer_state_dict': optimizer.state_dict(),
        }, checkpoint_path)
        print(f"체크포인트가 저장되었습니다: {checkpoint_path}")

    print('best epoch: {}, psnr: {:.2f}'.format(best_epoch, best_psnr))
    #최적의 매개변수가 best.pth에 저장
    torch.save(best_weights, os.path.join(args.outputs_dir, 'best.pth'))


# PS C:\Users\AERO\Desktop\super_resolution_code> python train.py --train-dir "C:/Users/AERO/Desktop/super_resolution_code/db/train" --outputs-dir "C:/Users/AERO/Desktop/super_resolution_code/outputs"
# epoch: 0/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:20<00:00, 69.15it/s, loss=0.023795]
# epoch: 1/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:13<00:00, 75.54it/s, loss=0.004286] 
# epoch: 2/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 76.84it/s, loss=0.003765] 
# epoch: 3/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:14<00:00, 74.20it/s, loss=0.003411] 
# epoch: 4/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.33it/s, loss=0.003278] 
# eval psnr: 25.96
# epoch: 5/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:21<00:00, 68.17it/s, loss=0.003245] 
# epoch: 6/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.92it/s, loss=0.003349] 
# epoch: 7/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.64it/s, loss=0.003199] 
# epoch: 8/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.55it/s, loss=0.003137] 
# epoch: 9/399: 100%|████████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.62it/s, loss=0.003151] 
# eval psnr: 26.16
# epoch: 10/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.23it/s, loss=0.003161] 
# epoch: 11/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [10:22<00:00,  8.89it/s, loss=0.003059] 
# epoch: 12/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:22<00:00, 66.92it/s, loss=0.003113]
# epoch: 13/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:04<00:00, 85.29it/s, loss=0.003043] 
# epoch: 14/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 97.01it/s, loss=0.002990] 
# eval psnr: 26.26
# epoch: 15/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.75it/s, loss=0.003030] 
# epoch: 16/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.91it/s, loss=0.002978] 
# epoch: 17/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.38it/s, loss=0.003029] 
# epoch: 18/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.15it/s, loss=0.003043]
# epoch: 19/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.47it/s, loss=0.003050] 
# eval psnr: 26.30
# epoch: 20/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:03<00:00, 87.52it/s, loss=0.002941] 
# epoch: 21/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:03<00:00, 87.67it/s, loss=0.003048] 
# epoch: 22/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.07it/s, loss=0.002994] 
# epoch: 23/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.22it/s, loss=0.002832] 
# epoch: 24/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 88.60it/s, loss=0.003040] 
# eval psnr: 26.40
# epoch: 25/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 92.00it/s, loss=0.002939] 
# epoch: 26/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.18it/s, loss=0.003021] 
# epoch: 27/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.48it/s, loss=0.002895] 
# epoch: 28/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.28it/s, loss=0.002868] 
# epoch: 29/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 82.13it/s, loss=0.002780] 
# eval psnr: 26.44
# epoch: 30/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:14<00:00, 73.86it/s, loss=0.002965] 
# epoch: 31/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:20<00:00, 69.17it/s, loss=0.002879] 
# epoch: 32/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:14<00:00, 74.40it/s, loss=0.002829] 
# epoch: 33/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.46it/s, loss=0.002930] 
# epoch: 34/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.49it/s, loss=0.002942] 
# eval psnr: 26.47
# epoch: 35/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.70it/s, loss=0.002915] 
# epoch: 36/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.15it/s, loss=0.002910] 
# epoch: 37/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 90.84it/s, loss=0.003061] 
# epoch: 38/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:01<00:00, 89.63it/s, loss=0.002880] 
# epoch: 39/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.51it/s, loss=0.002942] 
# eval psnr: 26.50
# epoch: 40/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.86it/s, loss=0.002837] 
# epoch: 41/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.23it/s, loss=0.002900] 
# epoch: 42/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.33it/s, loss=0.002813] 
# epoch: 43/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.59it/s, loss=0.002842] 
# epoch: 44/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.76it/s, loss=0.002867] 
# eval psnr: 26.53
# epoch: 45/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.33it/s, loss=0.002886] 
# epoch: 46/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.84it/s, loss=0.002823] 
# epoch: 47/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.62it/s, loss=0.002817] 
# epoch: 48/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.93it/s, loss=0.002921] 
# epoch: 49/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.77it/s, loss=0.002792] 
# eval psnr: 26.54
# epoch: 50/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.33it/s, loss=0.002834] 
# epoch: 51/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.03it/s, loss=0.002863] 
# epoch: 52/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.84it/s, loss=0.002876] 
# epoch: 53/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.99it/s, loss=0.002843] 
# epoch: 54/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.53it/s, loss=0.002808] 
# eval psnr: 26.57
# epoch: 55/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.16it/s, loss=0.002870] 
# epoch: 56/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.79it/s, loss=0.003036]
# epoch: 57/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.82it/s, loss=0.002810] 
# epoch: 58/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.12it/s, loss=0.002856] 
# epoch: 59/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.61it/s, loss=0.002863] 
# eval psnr: 26.58
# epoch: 60/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.18it/s, loss=0.002848] 
# epoch: 61/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.04it/s, loss=0.002798] 
# epoch: 62/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.31it/s, loss=0.002783] 
# epoch: 63/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.46it/s, loss=0.002886] 
# epoch: 64/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.23it/s, loss=0.002671] 
# eval psnr: 26.60
# epoch: 65/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 92.78it/s, loss=0.002835] 
# epoch: 66/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.12it/s, loss=0.002873] 
# epoch: 67/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.19it/s, loss=0.002794] 
# epoch: 68/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.38it/s, loss=0.002824] 
# epoch: 69/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 88.87it/s, loss=0.002858] 
# eval psnr: 26.58
# epoch: 70/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:01<00:00, 89.41it/s, loss=0.002833] 
# epoch: 71/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 94.75it/s, loss=0.002769] 
# epoch: 72/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.18it/s, loss=0.002903] 
# epoch: 73/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:01<00:00, 89.43it/s, loss=0.002852] 
# epoch: 74/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:01<00:00, 90.13it/s, loss=0.002799] 
# eval psnr: 26.63
# epoch: 75/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.81it/s, loss=0.002816] 
# epoch: 76/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.62it/s, loss=0.002865] 
# epoch: 77/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.90it/s, loss=0.002773] 
# epoch: 78/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.14it/s, loss=0.002674] 
# epoch: 79/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.40it/s, loss=0.002757] 
# eval psnr: 26.65
# epoch: 80/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [04:53<00:00, 18.86it/s, loss=0.002742] 
# epoch: 81/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 91.69it/s, loss=0.002771] 
# epoch: 82/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.59it/s, loss=0.002849] 
# epoch: 83/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.04it/s, loss=0.002829] 
# epoch: 84/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.49it/s, loss=0.002939] 
# eval psnr: 26.66
# epoch: 85/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 92.00it/s, loss=0.002822] 
# epoch: 86/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 92.59it/s, loss=0.002914] 
# epoch: 87/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.39it/s, loss=0.002680] 
# epoch: 88/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.01it/s, loss=0.002774] 
# epoch: 89/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.25it/s, loss=0.002756] 
# eval psnr: 26.66
# epoch: 90/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.73it/s, loss=0.002859] 
# epoch: 91/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.37it/s, loss=0.002860] 
# epoch: 92/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.86it/s, loss=0.002754] 
# epoch: 93/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.71it/s, loss=0.002685] 
# epoch: 94/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.90it/s, loss=0.002835] 
# eval psnr: 26.68
# epoch: 95/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.93it/s, loss=0.002716] 
# epoch: 96/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.92it/s, loss=0.002782] 
# epoch: 97/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [02:53<00:00, 31.95it/s, loss=0.002789] 
# epoch: 98/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.57it/s, loss=0.002803] 
# epoch: 99/399: 100%|███████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.40it/s, loss=0.002765] 
# eval psnr: 26.68
# epoch: 100/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.46it/s, loss=0.002701] 
# epoch: 101/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.45it/s, loss=0.002854] 
# epoch: 102/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.69it/s, loss=0.002776] 
# epoch: 103/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.97it/s, loss=0.002777] 
# epoch: 104/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.69it/s, loss=0.002763] 
# eval psnr: 26.71
# epoch: 105/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.22it/s, loss=0.002784] 
# epoch: 106/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.19it/s, loss=0.002825] 
# epoch: 107/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.58it/s, loss=0.002687] 
# epoch: 108/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.41it/s, loss=0.002697] 
# epoch: 109/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.97it/s, loss=0.002803] 
# eval psnr: 26.71
# epoch: 110/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.58it/s, loss=0.002711] 
# epoch: 111/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.24it/s, loss=0.002823] 
# epoch: 112/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.14it/s, loss=0.002717]
# epoch: 113/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.17it/s, loss=0.002878] 
# epoch: 114/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.96it/s, loss=0.002698] 
# eval psnr: 26.70
# epoch: 115/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.71it/s, loss=0.002664] 
# epoch: 116/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.21it/s, loss=0.002762] 
# epoch: 117/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.42it/s, loss=0.002735] 
# epoch: 118/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.34it/s, loss=0.002749] 
# epoch: 119/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.51it/s, loss=0.002810] 
# eval psnr: 26.72
# epoch: 120/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.59it/s, loss=0.002694] 
# epoch: 121/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.62it/s, loss=0.002742] 
# epoch: 122/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.25it/s, loss=0.002797] 
# epoch: 123/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.79it/s, loss=0.002691] 
# epoch: 124/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.90it/s, loss=0.002752] 
# eval psnr: 26.73
# epoch: 125/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.86it/s, loss=0.002687] 
# epoch: 126/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.64it/s, loss=0.002698] 
# epoch: 127/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.52it/s, loss=0.002761] 
# epoch: 128/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.39it/s, loss=0.002775]
# epoch: 129/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.70it/s, loss=0.002729]
# eval psnr: 26.74
# epoch: 130/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.63it/s, loss=0.002699] 
# epoch: 131/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.16it/s, loss=0.002599] 
# epoch: 132/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.12it/s, loss=0.002808] 
# epoch: 133/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.99it/s, loss=0.002621] 
# epoch: 134/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.17it/s, loss=0.002659] 
# eval psnr: 26.74
# epoch: 135/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.62it/s, loss=0.002627] 
# epoch: 136/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.49it/s, loss=0.002688] 
# epoch: 137/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.20it/s, loss=0.002737] 
# epoch: 138/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.98it/s, loss=0.002795] 
# epoch: 139/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.72it/s, loss=0.002786] 
# eval psnr: 26.76
# epoch: 140/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.59it/s, loss=0.002748] 
# epoch: 141/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.51it/s, loss=0.002801] 
# epoch: 142/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.01it/s, loss=0.002749] 
# epoch: 143/399: 100%|███████████████████████████████████████████████████████████| 5536/5536 [13:03:44<00:00,  8.49s/it, loss=0.002736] 
# epoch: 144/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:14<00:00, 74.74it/s, loss=0.002712] 
# eval psnr: 26.76
# epoch: 145/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.18it/s, loss=0.002722] 
# epoch: 146/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.69it/s, loss=0.002764] 
# epoch: 147/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.29it/s, loss=0.002738] 
# epoch: 148/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:17<00:00, 71.50it/s, loss=0.002745] 
# epoch: 149/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.61it/s, loss=0.002695] 
# eval psnr: 26.78
# epoch: 150/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.36it/s, loss=0.002662] 
# epoch: 151/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.47it/s, loss=0.002756] 
# epoch: 152/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.26it/s, loss=0.002680] 
# epoch: 153/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.45it/s, loss=0.002648] 
# epoch: 154/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 76.67it/s, loss=0.002822] 
# eval psnr: 26.78
# epoch: 155/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.18it/s, loss=0.002685] 
# epoch: 156/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:39<00:00, 55.77it/s, loss=0.002739] 
# epoch: 157/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:16<00:00, 72.22it/s, loss=0.002822] 
# epoch: 158/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.74it/s, loss=0.002767] 
# epoch: 159/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.36it/s, loss=0.002782] 
# eval psnr: 26.78
# epoch: 160/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.46it/s, loss=0.002783] 
# epoch: 161/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.03it/s, loss=0.002682] 
# epoch: 162/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.41it/s, loss=0.002730] 
# epoch: 163/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.62it/s, loss=0.002694] 
# epoch: 164/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.85it/s, loss=0.002778] 
# eval psnr: 26.77
# epoch: 165/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.64it/s, loss=0.002807] 
# epoch: 166/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.10it/s, loss=0.002645] 
# epoch: 167/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.05it/s, loss=0.002675] 
# epoch: 168/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.89it/s, loss=0.002695] 
# epoch: 169/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 82.87it/s, loss=0.002725] 
# eval psnr: 26.79
# epoch: 170/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.56it/s, loss=0.002697] 
# epoch: 171/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.19it/s, loss=0.002716] 
# epoch: 172/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.12it/s, loss=0.002686] 
# epoch: 173/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:15<00:00, 73.23it/s, loss=0.002705] 
# epoch: 174/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.78it/s, loss=0.002732] 
# eval psnr: 26.79
# epoch: 175/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:13<00:00, 75.17it/s, loss=0.002802] 
# epoch: 176/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.95it/s, loss=0.002706] 
# epoch: 177/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 92.21it/s, loss=0.002695] 
# epoch: 178/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.23it/s, loss=0.002699] 
# epoch: 179/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.23it/s, loss=0.002722] 
# eval psnr: 26.80
# epoch: 180/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.96it/s, loss=0.002754] 
# epoch: 181/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:01<00:00, 90.50it/s, loss=0.002725] 
# epoch: 182/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.70it/s, loss=0.002651] 
# epoch: 183/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 97.05it/s, loss=0.002710]
# epoch: 184/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.95it/s, loss=0.002822] 
# eval psnr: 26.80
# epoch: 185/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.41it/s, loss=0.002788] 
# epoch: 186/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.05it/s, loss=0.002780] 
# epoch: 187/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.26it/s, loss=0.002657] 
# epoch: 188/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.89it/s, loss=0.002633] 
# epoch: 189/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.91it/s, loss=0.002598] 
# eval psnr: 26.80
# epoch: 190/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.30it/s, loss=0.002596] 
# epoch: 191/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.47it/s, loss=0.002665] 
# epoch: 192/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.98it/s, loss=0.002717] 
# epoch: 193/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.47it/s, loss=0.002772] 
# epoch: 194/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.78it/s, loss=0.002676] 
# eval psnr: 26.79
# epoch: 195/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.67it/s, loss=0.002754] 
# epoch: 196/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.19it/s, loss=0.002821] 
# epoch: 197/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 93.94it/s, loss=0.002709] 
# epoch: 198/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.10it/s, loss=0.002680] 
# epoch: 199/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 92.81it/s, loss=0.002724] 
# eval psnr: 26.81
# epoch: 200/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 76.87it/s, loss=0.002751] 
# epoch: 201/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.27it/s, loss=0.002750] 
# epoch: 202/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.03it/s, loss=0.002839] 
# epoch: 203/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:16<00:00, 71.97it/s, loss=0.002769] 
# epoch: 204/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 93.69it/s, loss=0.002631] 
# eval psnr: 26.81
# epoch: 205/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.16it/s, loss=0.002647] 
# epoch: 206/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.47it/s, loss=0.002755] 
# epoch: 207/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.04it/s, loss=0.002664] 
# epoch: 208/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.60it/s, loss=0.002690] 
# epoch: 209/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.85it/s, loss=0.002648]
# eval psnr: 26.80
# epoch: 210/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.10it/s, loss=0.002739] 
# epoch: 211/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.63it/s, loss=0.002743] 
# epoch: 212/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.64it/s, loss=0.002731] 
# epoch: 213/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 82.75it/s, loss=0.002670] 
# epoch: 214/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.22it/s, loss=0.002749] 
# eval psnr: 26.82
# epoch: 215/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.54it/s, loss=0.002705] 
# epoch: 216/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.13it/s, loss=0.002673] 
# epoch: 217/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.08it/s, loss=0.002744] 
# epoch: 218/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.17it/s, loss=0.002708] 
# epoch: 219/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.13it/s, loss=0.002758] 
# eval psnr: 26.82
# epoch: 220/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:11<00:00, 77.12it/s, loss=0.002762] 
# epoch: 221/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.76it/s, loss=0.002764] 
# epoch: 222/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.56it/s, loss=0.002720] 
# epoch: 223/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.77it/s, loss=0.002613] 
# epoch: 224/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.85it/s, loss=0.002618] 
# eval psnr: 26.82
# epoch: 225/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.57it/s, loss=0.002671] 
# epoch: 226/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 82.41it/s, loss=0.002656] 
# epoch: 227/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.04it/s, loss=0.002698] 
# epoch: 228/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.18it/s, loss=0.002740] 
# epoch: 229/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 82.90it/s, loss=0.002690] 
# eval psnr: 26.84
# epoch: 230/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:05<00:00, 84.46it/s, loss=0.002628] 
# epoch: 231/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:04<00:00, 85.73it/s, loss=0.002698] 
# epoch: 232/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 83.09it/s, loss=0.002661] 
# epoch: 233/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 82.59it/s, loss=0.002713] 
# epoch: 234/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.71it/s, loss=0.002669] 
# eval psnr: 26.83
# epoch: 235/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.20it/s, loss=0.002662] 
# epoch: 236/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.09it/s, loss=0.002672] 
# epoch: 237/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.48it/s, loss=0.002705] 
# epoch: 238/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.36it/s, loss=0.002753] 
# epoch: 239/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.69it/s, loss=0.002709]
# eval psnr: 26.84
# epoch: 240/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.35it/s, loss=0.002746] 
# epoch: 241/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.18it/s, loss=0.002613] 
# epoch: 242/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.19it/s, loss=0.002652] 
# epoch: 243/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.98it/s, loss=0.002770] 
# epoch: 244/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.35it/s, loss=0.002747] 
# eval psnr: 26.84
# epoch: 245/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.88it/s, loss=0.002647] 
# epoch: 246/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.46it/s, loss=0.002624] 
# epoch: 247/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:58<00:00, 95.10it/s, loss=0.002788] 
# epoch: 248/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.87it/s, loss=0.002634] 
# epoch: 249/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.20it/s, loss=0.002716] 
# eval psnr: 26.76
# epoch: 250/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.40it/s, loss=0.002813] 
# epoch: 251/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 95.78it/s, loss=0.002628] 
# epoch: 252/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.80it/s, loss=0.002735] 
# epoch: 253/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:57<00:00, 96.81it/s, loss=0.002778] 
# epoch: 254/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.91it/s, loss=0.002776] 
# eval psnr: 26.85
# epoch: 255/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.80it/s, loss=0.002697] 
# epoch: 256/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.51it/s, loss=0.002730] 
# epoch: 257/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.58it/s, loss=0.002608] 
# epoch: 258/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.56it/s, loss=0.002797] 
# epoch: 259/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.16it/s, loss=0.002733] 
# eval psnr: 26.85
# epoch: 260/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.96it/s, loss=0.002727] 
# epoch: 261/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 89.14it/s, loss=0.002650] 
# epoch: 262/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 91.94it/s, loss=0.002724] 
# epoch: 263/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 91.22it/s, loss=0.002782] 
# epoch: 264/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 88.79it/s, loss=0.002769] 
# eval psnr: 26.84
# epoch: 265/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:04<00:00, 85.57it/s, loss=0.002695] 
# epoch: 266/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 88.77it/s, loss=0.002658] 
# epoch: 267/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 89.13it/s, loss=0.002702] 
# epoch: 268/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 91.37it/s, loss=0.002695] 
# epoch: 269/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 91.41it/s, loss=0.002646] 
# eval psnr: 26.85
# epoch: 270/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:02<00:00, 88.61it/s, loss=0.002735] 
# epoch: 271/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:59<00:00, 92.58it/s, loss=0.002688] 
# epoch: 272/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:00<00:00, 92.16it/s, loss=0.002792] 
# epoch: 273/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.36it/s, loss=0.002669] 
# epoch: 274/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.36it/s, loss=0.002718] 
# eval psnr: 26.86
# epoch: 275/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.57it/s, loss=0.002703] 
# epoch: 276/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.41it/s, loss=0.002736] 
# epoch: 277/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.38it/s, loss=0.002584] 
# epoch: 278/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.58it/s, loss=0.002777] 
# epoch: 279/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.83it/s, loss=0.002746] 
# eval psnr: 26.86
# epoch: 280/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.87it/s, loss=0.002594] 
# epoch: 281/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.08it/s, loss=0.002653] 
# epoch: 282/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.72it/s, loss=0.002755] 
# epoch: 283/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.38it/s, loss=0.002724] 
# epoch: 284/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.35it/s, loss=0.002767] 
# eval psnr: 26.83
# epoch: 285/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.76it/s, loss=0.002689] 
# epoch: 286/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.57it/s, loss=0.002696] 
# epoch: 287/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.71it/s, loss=0.002681] 
# epoch: 288/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.66it/s, loss=0.002688] 
# epoch: 289/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.67it/s, loss=0.002800] 
# eval psnr: 26.86
# epoch: 290/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.34it/s, loss=0.002633] 
# epoch: 291/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.67it/s, loss=0.002772] 
# epoch: 292/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.93it/s, loss=0.002681] 
# epoch: 293/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.05it/s, loss=0.002621] 
# epoch: 294/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.85it/s, loss=0.002774] 
# eval psnr: 26.86
# epoch: 295/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.14it/s, loss=0.002657] 
# epoch: 296/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 102.04it/s, loss=0.002616] 
# epoch: 297/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.49it/s, loss=0.002703] 
# epoch: 298/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.54it/s, loss=0.002559] 
# epoch: 299/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.97it/s, loss=0.002602] 
# eval psnr: 26.86
# epoch: 300/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.31it/s, loss=0.002602] 
# epoch: 301/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.68it/s, loss=0.002616] 
# epoch: 302/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.00it/s, loss=0.002620] 
# epoch: 303/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.75it/s, loss=0.002573] 
# epoch: 304/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.38it/s, loss=0.002715] 
# eval psnr: 26.85
# epoch: 305/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.47it/s, loss=0.002544] 
# epoch: 306/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.36it/s, loss=0.002731]
# epoch: 307/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.33it/s, loss=0.002697] 
# epoch: 308/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.79it/s, loss=0.002717] 
# epoch: 309/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.80it/s, loss=0.002727] 
# eval psnr: 26.87
# epoch: 310/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.17it/s, loss=0.002604] 
# epoch: 311/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.63it/s, loss=0.002574] 
# epoch: 312/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.88it/s, loss=0.002624] 
# epoch: 313/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.21it/s, loss=0.002666] 
# epoch: 314/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.90it/s, loss=0.002558] 
# eval psnr: 26.86
# epoch: 315/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.04it/s, loss=0.002782] 
# epoch: 316/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.67it/s, loss=0.002745] 
# epoch: 317/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.90it/s, loss=0.002879] 
# epoch: 318/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.83it/s, loss=0.002682] 
# epoch: 319/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.79it/s, loss=0.002701] 
# eval psnr: 26.88
# epoch: 320/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 98.98it/s, loss=0.002783] 
# epoch: 321/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.11it/s, loss=0.002706] 
# epoch: 322/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.67it/s, loss=0.002705] 
# epoch: 323/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.20it/s, loss=0.002687] 
# epoch: 324/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.14it/s, loss=0.002692] 
# eval psnr: 26.87
# epoch: 325/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.50it/s, loss=0.002618] 
# epoch: 326/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.38it/s, loss=0.002699] 
# epoch: 327/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.57it/s, loss=0.002609] 
# epoch: 328/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.42it/s, loss=0.002746] 
# epoch: 329/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.24it/s, loss=0.002708] 
# eval psnr: 26.87
# epoch: 330/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.40it/s, loss=0.002604] 
# epoch: 331/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.80it/s, loss=0.002646] 
# epoch: 332/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.58it/s, loss=0.002695] 
# epoch: 333/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.46it/s, loss=0.002741] 
# epoch: 334/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.20it/s, loss=0.002607] 
# eval psnr: 26.88
# epoch: 335/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.50it/s, loss=0.002688] 
# epoch: 336/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.80it/s, loss=0.002673] 
# epoch: 337/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.45it/s, loss=0.002713] 
# epoch: 338/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.85it/s, loss=0.002636] 
# epoch: 339/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.74it/s, loss=0.002632] 
# eval psnr: 26.87
# epoch: 340/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.26it/s, loss=0.002631] 
# epoch: 341/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.63it/s, loss=0.002633] 
# epoch: 342/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.00it/s, loss=0.002563] 
# epoch: 343/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 101.00it/s, loss=0.002672] 
# epoch: 344/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.44it/s, loss=0.002700] 
# eval psnr: 26.87
# epoch: 345/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.01it/s, loss=0.002679] 
# epoch: 346/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.72it/s, loss=0.002681] 
# epoch: 347/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.99it/s, loss=0.002611] 
# epoch: 348/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.41it/s, loss=0.002696] 
# epoch: 349/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.79it/s, loss=0.002682] 
# eval psnr: 26.89
# epoch: 350/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.68it/s, loss=0.002698] 
# epoch: 351/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.52it/s, loss=0.002703] 
# epoch: 352/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.81it/s, loss=0.002672] 
# epoch: 353/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.59it/s, loss=0.002656] 
# epoch: 354/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.89it/s, loss=0.002742] 
# eval psnr: 26.89
# epoch: 355/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.26it/s, loss=0.002693] 
# epoch: 356/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:54<00:00, 100.91it/s, loss=0.002678] 
# epoch: 357/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.33it/s, loss=0.002639] 
# epoch: 358/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 98.68it/s, loss=0.002688] 
# epoch: 359/399: 100%|█████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 100.09it/s, loss=0.002709] 
# eval psnr: 26.87
# epoch: 360/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.79it/s, loss=0.002672] 
# epoch: 361/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:55<00:00, 99.35it/s, loss=0.002652] 
# epoch: 362/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [00:56<00:00, 97.24it/s, loss=0.002622] 
# epoch: 363/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 75.85it/s, loss=0.002694] 
# epoch: 364/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:15<00:00, 72.93it/s, loss=0.002635] 
# eval psnr: 26.90
# epoch: 365/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.04it/s, loss=0.002682] 
# epoch: 366/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.42it/s, loss=0.002774] 
# epoch: 367/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.32it/s, loss=0.002621] 
# epoch: 368/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.46it/s, loss=0.002663] 
# epoch: 369/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.05it/s, loss=0.002616] 
# eval psnr: 26.88
# epoch: 370/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.53it/s, loss=0.002709] 
# epoch: 371/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.94it/s, loss=0.002600] 
# epoch: 372/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.30it/s, loss=0.002758] 
# epoch: 373/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.46it/s, loss=0.002688] 
# epoch: 374/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.78it/s, loss=0.002635] 
# eval psnr: 26.89
# epoch: 375/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.09it/s, loss=0.002733] 
# epoch: 376/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.27it/s, loss=0.002748] 
# epoch: 377/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.62it/s, loss=0.002728] 
# epoch: 378/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.97it/s, loss=0.002680] 
# epoch: 379/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.07it/s, loss=0.002660] 
# eval psnr: 26.88
# epoch: 380/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.42it/s, loss=0.002668] 
# epoch: 381/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.94it/s, loss=0.002720] 
# epoch: 382/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:06<00:00, 82.93it/s, loss=0.002639] 
# epoch: 383/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 82.27it/s, loss=0.002773] 
# epoch: 384/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:07<00:00, 81.91it/s, loss=0.002779] 
# eval psnr: 26.89
# epoch: 385/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.29it/s, loss=0.002612] 
# epoch: 386/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.73it/s, loss=0.002559] 
# epoch: 387/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [05:30<00:00, 16.73it/s, loss=0.002772] 
# epoch: 388/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 76.79it/s, loss=0.002684] 
# epoch: 389/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.94it/s, loss=0.002609] 
# eval psnr: 26.90
# epoch: 390/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.93it/s, loss=0.002585] 
# epoch: 391/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 81.04it/s, loss=0.002592] 
# epoch: 392/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.50it/s, loss=0.002614] 
# epoch: 393/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:08<00:00, 80.47it/s, loss=0.002626] 
# epoch: 394/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:09<00:00, 79.34it/s, loss=0.002594] 
# eval psnr: 26.90
# epoch: 395/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:10<00:00, 78.12it/s, loss=0.002668] 
# epoch: 396/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:13<00:00, 75.27it/s, loss=0.002675] 
# epoch: 397/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:14<00:00, 74.49it/s, loss=0.002677] 
# epoch: 398/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:13<00:00, 75.66it/s, loss=0.002694] 
# epoch: 399/399: 100%|██████████████████████████████████████████████████████████████| 5536/5536 [01:12<00:00, 76.03it/s, loss=0.002610] 
# eval psnr: 26.89
# best epoch: 394, psnr: 26.90
# PS C:\Users\AERO\Desktop\super_resolution_code> 